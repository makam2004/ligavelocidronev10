<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liga Velocidrone</title>
  <link rel="stylesheet" href="/style-home.css" />
  <link rel="stylesheet" href="/style-ui.css" />
</head>
<body class="home">
  <header class="wrap">
    <h1>üèÅ Liga Velocidrone</h1>
    <div class="muted">v1</div>
  </header>
  <main class="wrap">
    <section class="main-card">
      <div id="tracks" class="mb"></div>
      <div id="status" class="status muted"></div>
      <div id="leaderboard">
        <table>
          <thead><tr><th>#</th><th>Piloto</th><th>Pa√≠s</th><th>Modelo</th><th>Tiempo</th></tr></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    async function fetchJSON(url){
      const r = await fetch(url);
      const t = await r.text();
      try { return { ok: r.ok, status: r.status, data: JSON.parse(t) }; }
      catch { return { ok: false, status: r.status, data: t }; }
    }
    async function loadTracks(){
      const box = document.getElementById('tracks');
      const res = await fetchJSON('/api/tracks/active');
      if(!res.ok){ box.innerHTML = `<div class="error">Error al cargar tracks activos:<br>HTTP ${res.status} - ${res.data && res.data.error ? res.data.error : res.data}</div>`; return null; }
      const tracks = (res.data && res.data.tracks) ? res.data.tracks : [];
      if(!tracks.length){ box.innerHTML = `<div class="muted">No hay tracks activos en la base de datos.</div>`; return null; }
      box.innerHTML = `
        <div class="tabs">
          ${tracks.map((t,i)=>`<button class="btn ${i===0?'active':''}" data-i="${i}">${t.name || (t.is_official ? `Oficial ${t.track_id}` : `No oficial`) } ¬∑ ${t.laps} lap</button>`).join('')}
        </div>
      `;
      box.querySelectorAll('.btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          box.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const t = tracks[Number(btn.dataset.i)];
          loadLeaderboard(t);
        });
      });
      await loadLeaderboard(tracks[0]);
      return tracks;
    }
    async function loadLeaderboard(track){
      const status = document.getElementById('status');
      const table = document.getElementById('table-body');
      table.innerHTML = '';
      status.textContent = 'Cargando leaderboard‚Ä¶';
      let url = '/api/leaderboard';
      const q = [];
      if (track) {
        if (track.is_official) { q.push(`track_id=${track.track_id}`); }
        else if (track.online_id) { q.push(`online_id=${encodeURIComponent(track.online_id)}`); }
        q.push(`laps=${track.laps}`);
      }
      if (q.length) url += `?${q.join('&')}`;
      const res = await fetchJSON(url);
      if(!res.ok){
        status.innerHTML = `<span class="error">Error al cargar leaderboard:<br>HTTP ${res.status} - ${res.data && res.data.error ? res.data.error : res.data}</span>`;
        return;
      }
      const data = res.data;
      status.innerHTML = `<span class="muted">Se muestran ${data.meta && data.meta.returned_count !== undefined ? data.meta.returned_count : (data.results?data.results.length:0)} pilotos dados de alta en la liga.</span>`;
      const rows = (data.results || []).map(r => `
        <tr>
          <td data-label="#">${r.position}</td>
          <td data-label="Piloto">${r.playername || '-'}</td>
          <td data-label="Pa√≠s">${r.country || '-'}</td>
          <td data-label="Modelo">${r.model_name || '-'}</td>
          <td data-label="Tiempo">${r.lap_time || '-'}</td>
        </tr>`).join('');
      table.innerHTML = rows || `<tr><td colspan="5" class="muted">No hay resultados para los pilotos dados de alta.</td></tr>`;
    }
    document.addEventListener('DOMContentLoaded', loadTracks);
  </script>
</body>
</html>
